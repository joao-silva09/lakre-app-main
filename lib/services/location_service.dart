import 'dart:async';
import 'package:location/location.dart';
import 'package:pigma/backend/schema/structs/positions_struct.dart';
import '/flutter_flow/flutter_flow_util.dart'; // para FFAppState

class LocationService {
  static StreamSubscription<LocationData>? _locSub;
  static DateTime _lastRecorded = DateTime.now();

  /// Inicia a coleta de localização a cada ≥5 min em background
  static Future<void> start() async {
    final loc = Location();

    if (!await loc.serviceEnabled() && !await loc.requestService()) return;
    if (await loc.hasPermission() == PermissionStatus.denied &&
        await loc.requestPermission() != PermissionStatus.granted) {
      return;
    }
    await loc.enableBackgroundMode(enable: true);

    print(
        '🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢 [LocationService] started at ${DateTime.now()}');

    _locSub = loc.onLocationChanged.listen((data) {
      final now = DateTime.now();
      if (now.difference(_lastRecorded).inMinutes >= 1) {
        _lastRecorded = now;

        print(
            '📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍📍 [LocationService] captured location ' +
                'lat=${data.latitude}, lng=${data.longitude} at $now');

        FFAppState().addToPositions(PositionsStruct(
          cpf: FFAppState().cpf,
          routeId: FFAppState().routeSelected.routeId,
          latitude: data.latitude,
          longitude: data.longitude,
          date: now
              .subtract(now.timeZoneOffset)
              .subtract(const Duration(hours: 3)),
          finish: false,
        ));
      }
    });
  }

  /// Para a coleta
  static Future<void> stop() async {
    print(
        '🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴🔴 [LocationService] stopping at ${DateTime.now()}');
    await _locSub?.cancel();
    _locSub = null;
  }
}
